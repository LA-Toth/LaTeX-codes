% Copyright (c) 2024-2025, Laszlo Attila Toth
%
% My main set up for a book
% May also work for other documents
%
% It uses titlesec, so not compatible with scrbook (KOMA-Script)

% initialization
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{tlabook}[2025/11/26]
% packages
\usepackage[a4paper,twoside,top=1.5cm,bottom=2.5cm]{geometry}

\RequirePackage{color}
\RequirePackage{calc}
\RequirePackage{expl3}
\RequirePackage{fontspec} % LuaLaTeX
\RequirePackage{fancyhdr}
\RequirePackage{listings}
\RequirePackage{tcolorbox}
\RequirePackage{shorttoc}
\RequirePackage{titlesec}
\RequirePackage{titletoc}
\RequirePackage{amssymb}
\RequirePackage{marginnote}
\RequirePackage{hyperref}
\RequirePackage{varioref}
\RequirePackage{cleveref} % last

% initial code
% options
% loading options
% package loading
% main code

\definecolor{darkblue}{rgb}{0, 0, 0.4}
\definecolor{gold}{rgb}{1.0, 0.84, 0.0}
\definecolor{ChapNoColor}{cmyk}{0.17,0.12,0.12,0}	% Chapter Label(No.)
%\definecolor{ChapTitleColor}{cmyk}{0.77,0.52,0.33,0.09} % Chapter Title Text
\definecolor{ChapTitleColor}{rgb}{.2,.2,.8}
\definecolor{SecLevelsColor}{RGB}{71, 107, 133} % Color of Sectional Levels Head
\definecolor{HighlightBodyColor}{cmyk}{0.57,0.48,0.48,0.15} % Highlight Env. Color
\definecolor{ChapTopBack}{cmyk}{0.02,0.03,0.08,0} % ChapterTopics Env. Background

\hypersetup{
  colorlinks = true,
  linkcolor=darkblue,
  urlcolor=blue,
  citecolor=blue
}

% Increase the vertical space between the paragraphs
\setlength{\parskip}{5pt}
\setlength{\headheight}{15pt}

\setmainfont{EB Garamond}
%\setheadingfont{kurier}

\setmainfont{EB Garamond}
%\setheadingfont{kurier}

\fancypagestyle{twoside}{%
  \fancyhf{}%
  \fancyhead[CE]{{\textcolor{black}{\nouppercase{\textbf \leftmark}}}}%
  \fancyhead[CO]{{\textcolor{black}{\nouppercase{\textbf \rightmark}}}}%
  \fancyhead[RE]{\thepage}
  \fancyhead[LO]{\thepage}
}
\fancypagestyle{ChapterMainStyle}{
  \fancyhf{}%
  \fancyhead[CE]{{\textcolor{black}{\nouppercase{\bf\leftmark}}}}%
  \fancyhead[CO]{{\textcolor{black}{\nouppercase{\bf\rightmark}}}}%
  \fancyhead[RO]{%
    \makebox[0pt][l]{%
      \begin{tikzpicture}[remember picture,overlay]
        \fill[blue!20]
          ([xshift=-\marginparwidth+\marginparsep]current page.north east) rectangle
          ([yshift=-1in-\topmargin-\headheight-\voffset-\headruleskip]current page.north east);
        \draw[line width=1.4pt]
          ([xshift=-\marginparwidth+\marginparsep]current page.north east) --
          ([xshift=-\marginparwidth+\marginparsep,yshift=-1in-\topmargin-\headheight-\voffset-\headruleskip]current page.north east);
      \end{tikzpicture}%
      \hspace*{0.7em}%
      {\bf\large \thepage}%
    }%
  }
  \fancyhead[LE]{%
    \makebox[0pt][r]{%
      \begin{tikzpicture}[remember picture,overlay]
        \fill[blue!20]
          (current page.north west) rectangle
          ([xshift=\marginparwidth-\marginparsep,yshift=-1in-\topmargin-\headheight-\voffset-\headruleskip]current page.north west);
        \draw[line width=1.4pt]
          ([xshift=\marginparwidth-\marginparsep]current page.north west) --
          ([xshift=\marginparwidth-\marginparsep,yshift=-1in-\topmargin-\headheight-\voffset-\headruleskip]current page.north west);
      \end{tikzpicture}%
      {\bf\large \thepage}%
      \hspace*{0.7em}%
    }%
  }
  \renewcommand{\headrulewidth}{0pt}}

\fancypagestyle{FMPageStyle}{
  \fancyhf{}
  \renewcommand{\headrulewidth}{0pt}
}
\fancypagestyle{FrontMatterMainPages}{
  \fancyhf{}
  \renewcommand{\headrulewidth}{0pt}
}
\renewcommand{\headrule}{%
  \vskip-6pt
  \vskip-\headruleskip
  \ifodd\value{page}%
    \hspace*{-\oddsidemargin}\hspace*{-1in}%
  \else%
    \hspace*{-\evensidemargin}\hspace*{-1in}%
  \fi%
  \makebox[0pt][l]{\rule{\paperwidth}{0.5pt}}%
  \vskip\headruleskip
  \vskip\headrulewidth
}
\titleclass{\part}{top}
\titleformat{\part}[display]
{\vspace*{-3cm}\raggedleft\color{ChapTitleColor}}
{
    \raggedleft\resizebox{!}{\baselineskip}{\underline{\partname~\thepart}}
}
{20pt}
{\ChapHeadFont\fontsize{40pt}{42pt}\selectfont}[\vspace{-5cm}]

\makeatletter
% chapter header format
%\titleformat{\chapter}[display]{%
%    \Huge\centering%
%}{%
%    \raggedleft{\resizebox{2\baselineskip}{!}{\itshape\color{gray} \thechapter}}%
%}{1ex}{%
%    \titleline{\color{gray}\titlerule[1pt]\vspace{1ex}}%
%}[\vspace{1.5ex}\titleline{\color{gray}\titlerule[1pt]}%
%    {\startcontents\c@tocdepth=1\printcontents{p-}{1}{\contentsmargin{0pt}}}
%]
%\definecolor{ChapTitleColor}{rgb}{0,0,1}
%\definecolor{ChapNoColor}{rgb}{0,0,1}
\newcommand\ChapHeadFont{}
\newcommand{\LowerRule}[1]{\vspace{-15pt}\rule{#1\linewidth}{0.5pt}}
%\newcommand\selectfont{}
%% The Chapter Head Format
%% Centering the Chapter Title Text Vertically over the Chapter Label(No.):
%%   1. Measure the heights of both and assign them into length variables.
%%   2. Apply: S <sep value, a length par> = -(Z-Y)/2, where: Z<Label Height>, Y<Text>
\titleformat{\chapter}[display]
%       {\raggedleft\color{ChapNoColor}}
%
{%
    \vspace*{1.5ex}\huge\centering%
}%
%{\ChapHeadFont\fontsize{225pt}{230pt}\selectfont\thechapter}
% {\ChapHeadFont\fontsize{225pt}{230pt}\selectfont\thechapter}
%{\raggedleft{\resizebox{2\baselineskip}{!}{\itshape\color{gray} \thechapter}}}
{\raggedleft{\resizebox{!}{6\baselineskip}{\itshape\fontsize{225pt}{230pt}\color{ChapNoColor} \thechapter}}}
{-110pt}
{\ChapHeadFont\fontsize{30pt}{30pt}\selectfont\color{ChapTitleColor}\bf}
[\LowerRule{0.7}]

\newcommand{\useappendixchapterformat}{
    \titleformat{\chapter}[display]
    %       {\raggedleft\color{ChapNoColor}}
    %
    {%
        \vspace*{1.5ex}\huge\centering%
    }%
    %{\ChapHeadFont\fontsize{225pt}{230pt}\selectfont\thechapter}
    % {\ChapHeadFont\fontsize{225pt}{230pt}\selectfont\thechapter}
    %{\raggedleft{\resizebox{2\baselineskip}{!}{\itshape\color{gray} \thechapter}}}
    {\raggedleft{\itshape\color{ChapNoColor}\textbf{Appendix}\resizebox{!}{6\baselineskip}{%
    \itshape\color{ChapNoColor} \thechapter}}}%
    {-110pt}%
    {\ChapHeadFont\fontsize{30pt}{30pt}\selectfont\color{ChapTitleColor}\bf}
    [\LowerRule{0.7}]
}

%% Formatting the Front Matter Numberless Chapters, Preface, Acknowledgments,...
\titleformat{name=\chapter,numberless}[display]
{\vspace*{7cm}\raggedleft}{}{0pt}
{\ChapHeadFont\fontsize{30pt}{30pt}\selectfont\color{ChapTitleColor}}
[\LowerRule{1}]
\makeatother

\newcommand\tocseparatorsymbol{{\tiny\ensuremath{\textcolor{gray}\blacksquare}}}
\titlespacing*{\chapter}{1pc}{*4}{*2.3}[1pc]
\titlecontents*{p-section}[0pt]{\small\itshape\fillast}{}{}{}[ --- ][.]
\titlecontents*{subsection}[50pt]{\small\itshape\fillast}{}{}{\enskip\thecontentspage}[\enskip\tocseparatorsymbol\enskip]

%
% Add support of brief TOC, like in a Manning book
%
\newcommand{\brieftableofcontents}{\shorttableofcontents{Brief Contents}{0}}

% a format for menu delimited by \textrightarrow
% where each menu entry is \emph
% like \emph{File -> Open}, written as \menu{File}[Open]
% up to 3 optional args (beyond that the menu UX is bad)
\NewDocumentCommand\menu{m!ooo}{%
    \emph{#1%
        \IfNoValueF{#2}{\space\textrightarrow\space#2%
            \IfNoValueF{#3}{\space\textrightarrow\space#3%
                \IfNoValueF{#4}{\space\textrightarrow\space#4}%
            }%
        }}%
}

% When the \emph and the \index are needed at the same time
\newcommand{\emphidx}[1]{\emph{#1}\index{#1}}

\newcommand{\ChapterMarkFont}{}
\newcommand{\HighlightTitleFont}{}
\newcommand{\HighlightBodyFont}{}
\newcommand{\BigPartLetterFont}{}
\newcommand{\BigPartLetter}[1]{
    {\BigPartLetterFont\fontsize{35}{36}\selectfont\color{ChapTitleColor}#1}
}

\newcommand{\chapterskip}{\vspace{2cm}}

%\renewcommand\raggedrightmarginnote{\centering}
\renewcommand\marginfont{\strut\color{darkblue}\sffamily\it}
\NewDocumentCommand{\TlaBookMarginNote}{m O{8pt}}{%
  \marginnote{#1}[#2]}

\usepackage[all]{nowidow}

\ExplSyntaxOn

% TlaBookDefineSCItem::
% new commands: #2 => \sc#2 and \sc#2i (i: to add to the index, as #1!#2)
% recommended usage: indirectly, by defining eg:
% \newcommand\definecustomer[1]{\TlaBookDefineSCItem{customer}{#1}}
% and then \definecustomer{IBM} (\scibm, \scibmi)
\newcommand{\TlaBookDefineSCItem}[2]{
  \define_TBscitem:nn {#1} {#2}
}

% Internal function to define commands
\cs_new_protected:Nn \define_TBscitem:nn {
  % #1 = category (e.g., customers, devices)
  % #2 = display name (e.g., IBM)

  % Convert display name to lowercase for command name
  \tl_set:Nn \l_tmpa_tl { \tl_lower_case:n {#2} }

  % Define \<lowercase> as small caps
  \cs_new:cpn { sc \l_tmpa_tl } { \textsc{#2} }

  % Define \<lowercase>i as indexed version
  \cs_new:cpn { sc \l_tmpa_tl i } {
    \csname \l_tmpa_tl \endcsname \index{#1!#2}
  }
}

\ExplSyntaxOff

\newcommand{\blankpage}{
  \clearpage
  \thispagestyle{empty}
  \null\vfill
  \begin{center}
    \textit{This page is intentionally left blank}
  \end{center}
  \vfill\null
  \clearpage
}
\newcommand{\maybeBlankPage}{
  \clearpage
  \ifodd\value{page}\else
    \blankpage
  \fi
}

\newenvironment{TlaBookNote}{
  \begin{center}
    \begin{minipage}{0.9\textwidth}
      {\ChapterMarkFont\fontsize{11.5pt}{12pt}\selectfont
        \color{SecLevelsColor} NOTE~ }
      }{
    \end{minipage}
  \end{center}
}

\newenvironment{TlaBookHighlight}[1]{ % Use: <\par\noindent> infront of Body Paragraph
  \vspace{0.5cm}
  \begin{tcolorbox}
    {\HighlightTitleFont\fontsize{14}{15}\selectfont #1}
    \vspace{5pt}
    \begin{spacing}{1.2}
      \HighlightBodyFont\fontsize{12}{13}\color{HighlightBodyColor}\selectfont
      }{
    \end{spacing}
    \vspace{-0.5pt}
  \end{tcolorbox}
  \vspace{0.5cm}
}

\lstdefinestyle{yaml}{
     basicstyle=\color{blue}\footnotesize,
     rulecolor=\color{black},
     string=[s]{'}{'},
     stringstyle=\color{blue},
     comment=[l]{:},
     commentstyle=\color{black},
     morecomment=[l]{-}
 }

\makeatletter
\def\cleardoublepage{%
  \clearpage
  \if@twoside
    \ifodd\c@page
    \else
      \null
      \thispagestyle{empty}% no header/footer
      \vfill
      \begin{center}
        \textit{This page intentionally left blank}
      \end{center}
      \vfill
      \newpage
    \fi
  \fi
}
\makeatother
